#include "norm-cdf-approx.h"
namespace {
constexpr double const h = 0.0200595552495038,
                    hinv = 1. / h,
                    xmax = 5.99780701960164,
              pnorm_xmax = 0.999999999,
                    xinf = 8.12589066470191; // qnorm(1 - .Machine$double.eps)
constexpr int const n_pts = 300L;
constexpr double const d_xmy[3L * n_pts] = {
    0, 0.398915527234312, 0.5, 0.0200595552495038, 0.398835287106651, 0.508002068058442, 0.0401191104990076, 0.398594663550404, 0.516000916954335, 0.0601786657485114, 0.398193946851061, 0.523993331409735, 0.0802382209980152, 0.397633620169299, 0.531976103908089, 0.100297776247519, 0.396914358570157, 0.539946038555428, 0.120357331497023, 0.396037027667709, 0.547899954918208, 0.140416886746527, 0.395002681889087, 0.555834691830127, 0.16047644199603, 0.393812562362633, 0.56374711116032, 0.180535997245534, 0.392468094436193, 0.571634101535451, 0.200595552495038, 0.390970884832435, 0.579492582008341, 0.220655107744542, 0.389322718449186, 0.587319505665938, 0.240714662994046, 0.38752555481366, 0.595111863169578, 0.260774218243549, 0.385581524200481, 0.602866686220696, 0.280833773493053, 0.383492923424246, 0.610581050945353, 0.300893328742557, 0.381262211318223, 0.618252081191141, 0.320952883992061, 0.378892003911728, 0.625876951730324, 0.341012439241565, 0.376385069319328, 0.633452891363266, 0.361071994491069, 0.373744322355893, 0.640977185916523, 0.381131549740572, 0.370972818892136, 0.648447181130239, 0.401191104990076, 0.368073749965942, 0.655860285429785, 0.42125066023958, 0.365050435665351, 0.663213972576907, 0.441310215489084, 0.361906318799589, 0.670505784195954, 0.461369770738588, 0.358644958375037, 0.677733332171117, 0.481429325988091, 0.355270022893376, 0.684894300910914, 0.501488881237595, 0.3517852834896, 0.691986449476561, 0.521548436487099, 0.348194606927762, 0.699007613571158, 0.541607991736603, 0.344501948472634, 0.705955707387054, 0.561667546986107, 0.340711344655643, 0.712828725309055, 0.58172710223561, 0.336826905953501, 0.719624743471559, 0.601786657485114, 0.332852809398012, 0.726341921168043, 0.621846212734618, 0.328793291135571, 0.732978502111703, 0.641905767984122, 0.324652638954782, 0.739532815546443, 0.661965323233626, 0.320435184800476, 0.746003277207725, 0.682024878483129, 0.316145297292279, 0.752388390133223, 0.702084433732633, 0.311787374265555, 0.758686745323535, 0.722143988982137, 0.307365835352369, 0.764897022253578, 0.742203544231641, 0.302885114619706, 0.771017989235657, 0.762263099481145, 0.298349653281773, 0.777048503635511, 0.782322654730648, 0.293763892502814, 0.782987511943009, 0.802382209980152, 0.289132266306343, 0.78883404969945, 0.822441765229656, 0.284459194606215, 0.794587241283782, 0.84250132047916, 0.279749076374294, 0.800246299560315, 0.862560875728664, 0.275006282959007, 0.805810525390837, 0.882620430978167, 0.27023515156821, 0.811279307014269, 0.902679986227671, 0.265439978929368, 0.816652119297318, 0.922739541477175, 0.260625015139143, 0.821928522859791, 0.942799096726679, 0.255794457713828, 0.827108163078491, 0.962858651976183, 0.250952445851295, 0.832190768973846, 0.982918207225686, 0.246103054914322, 0.837176151983595, 1.00297776247519, 0.24125029114445, 0.842064204628097, 1.02303731772469, 0.236398086614533, 0.846854899071937, 1.0430968729742, 0.231550294427528, 0.851548285586739, 1.0631564282237, 0.226710684168111, 0.856144490920153, 1.08321598347321, 0.221882937612852, 0.860643716576185, 1.10327553872271, 0.217070644703967, 0.865046237012087, 1.12333509397221, 0.212277299790712, 0.869352397757154, 1.14339464922172, 0.207506298141691, 0.873562613458822, 1.16345420447122, 0.202760932730534, 0.877677365861541, 1.18351375972072, 0.198044391296584, 0.88169720172392, 1.20357331497023, 0.193359753681435, 0.885622730679677, 1.22363287021973, 0.188709989441333, 0.889454623047927, 1.24369242546924, 0.184097955734754, 0.893193607598341, 1.26375198071874, 0.179526395483673, 0.896840469276691, 1.28381153596824, 0.174997935806323, 0.900396046896239, 1.30387109121775, 0.170515086718543, 0.903861230800403, 1.32393064646725, 0.16608024010016, 0.907236960502048, 1.34399020171676, 0.161695668922193, 0.910524222304683, 1.36404975696626, 0.157363526729954, 0.913724046910748, 1.38410931221576, 0.153085847376746, 0.916837507022075, 1.40416886746527, 0.148864545002105, 0.91986571493749, 1.42422842271477, 0.144701414248091, 0.922809820152399, 1.44428797796427, 0.140598130706644, 0.925671006965072, 1.46434753321378, 0.136556251590612, 0.928450492094173, 1.48440708846328, 0.13257721662054, 0.931149522311966, 1.50446664371279, 0.128662349119029, 0.933769372097423, 1.52452619896229, 0.1248128573041, 0.936311341313334, 1.54458575421179, 0.121029835772667, 0.938776752911303, 1.5646453094613, 0.117314267164991, 0.941166950668375, 1.5847048647108, 0.113667024000761, 0.943483296958806, 1.6047644199603, 0.110088870677214, 0.945727170564354, 1.62482397520981, 0.106580465619584, 0.947899964526216, 1.64488353045931, 0.103142363574047, 0.950003084041582, 1.66494308570882, 0.0997750180332028, 0.952037944407572, 1.68500264095832, 0.0964787837841506, 0.954005969015097, 1.70506219620782, 0.0932539195691245, 0.955908587395018, 1.72512175145733, 0.0901005908487176, 0.957747233318756, 1.74518130670683, 0.0870188726577426, 0.959523342955304, 1.76524086195633, 0.0840087525438568, 0.961238353086411, 1.78530041720584, 0.0810701335791919, 0.962893699381494, 1.80535997245534, 0.0782028374353385, 0.964490814733644, 1.82541952770485, 0.0754066075121941, 0.966031127657899, 1.84547908295435, 0.072681112111434, 0.967516060752781, 1.86553863820385, 0.0700259476454167, 0.968947029225888, 1.88559819345336, 0.0674406418727003, 0.970325439484165, 1.90565774870286, 0.0649246571515701, 0.971652687789303, 1.92571730395237, 0.0624773937031544, 0.972930158978539, 1.94577685920187, 0.0600981928761017, 0.97415922525097, 1.96583641445137, 0.0577863404049681, 0.975341245019326, 1.98589596970088, 0.0555410696549145, 0.97647756182701, 2.00595552495038, 0.0533615648455075, 0.977569503330045, 2.02601508019988, 0.0512469642467897, 0.978618380343447, 2.04607463544939, 0.0491963633411762, 0.9796254859514, 2.06613419069889, 0.0472088179450146, 0.980592094680481, 2.0861937459484, 0.0452833472840228, 0.981519461735064, 2.1062533011979, 0.0434189370171938, 0.982408822293934, 2.1263128564474, 0.0416145422040742, 0.983261390867006, 2.14637241169691, 0.0398690902107403, 0.984078360710984, 2.16643196694641, 0.038181483550128, 0.984860903302666, 2.18649152219591, 0.036550602652707, 0.985610167868548, 2.20655107744542, 0.0349753085638981, 0.986327280969295, 2.22661063269492, 0.0334544455649573, 0.98701334613756, 2.24667018794443, 0.0319868437144148, 0.987669443567599, 2.26672974319393, 0.030571321307485, 0.988296629855053, 2.28678929844343, 0.0292066872512035, 0.988895937785234, 2.30684885369294, 0.027891743353399, 0.989468376168194, 2.32690840894244, 0.0266252865238941, 0.990014929718839, 2.34696796419195, 0.0254061108866792, 0.990536558980314, 2.36702751944145, 0.0242330098020793, 0.991034200288852, 2.38708707469095, 0.0231047777982061, 0.991508765778287, 2.40714662994046, 0.0220202124113513, 0.991961143422393, 2.42720618518996, 0.0209781159351329, 0.99239219711323, 2.44726574043946, 0.0199772970785433, 0.992802766773656, 2.46732529568897, 0.0190165725332801, 0.993193668502195, 2.48738485093847, 0.0180947684509325, 0.993565694748431, 2.50744440618798, 0.0172107218308615, 0.993919614517132, 2.52750396143748, 0.0163632818198104, 0.994256173599331, 2.54756351668698, 0.0155513109244467, 0.994576094828588, 2.56762307193649, 0.0147736861382261, 0.994880078360713, 2.58768262718599, 0.0140292999841667, 0.995168801975245, 2.60774218243549, 0.0133170614752604, 0.995442921397002, 2.627801737685, 0.0126358969943437, 0.995703070636093, 2.6478612929345, 0.0119847510954341, 0.995949862344772, 2.66792084818401, 0.0113625872286485, 0.996183888189594, 2.68798040343351, 0.0107683883908992, 0.996405719237353, 2.70803995868301, 0.0102011577046362, 0.996615906353344, 2.72809951393252, 0.00965991892705086, 0.996814980610523, 2.74815906918202, 0.00914371689216841, 0.99700345370819, 2.76821862443153, 0.00865161788829313, 0.997181818398891, 2.78827817968103, 0.00818270997339462, 0.997350548922246, 2.80833773493053, 0.0077361032309923, 0.997510101444495, 2.82839729018004, 0.00731092996912636, 0.997660914502602, 2.84845684542954, 0.00690634486504416, 0.997803409451777, 2.86851640067904, 0.00652152505823668, 0.997937990915387, 2.88857595592855, 0.00615567019442859, 0.998065047236211, 2.90863551117805, 0.00580800242311496, 0.998184950928112, 2.92869506642756, 0.0054777663512862, 0.998298059127202, 2.94875462167706, 0.00516422895587597, 0.998404714041647, 2.96881417692656, 0.00486667945745469, 0.998505243399325, 2.98887373217607, 0.00458442915770563, 0.998599960892564, 3.00893328742557, 0.00431681124311108, 0.998689166619278, 3.02899284267507, 0.00406318055724925, 0.99877314751983, 3.04905239792458, 0.00382291334407602, 0.998852177809032, 3.06911195317408, 0.00359540696449309, 0.998926519402709, 3.08917150842359, 0.00338007958839303, 0.998996422338329, 3.10923106367309, 0.00317636986438538, 0.999062125189211, 3.12929061892259, 0.00298373656930203, 0.999123855471904, 3.1493501741721, 0.00280165823951607, 0.999181830046335, 3.1694097294216, 0.00262963278602145, 0.999236255508396, 3.18946928467111, 0.0024671770951371, 0.999287328574649, 3.20952883992061, 0.0023138266166997, 0.999335236458896, 3.22958839517011, 0.00216913494144702, 0.99938015724036, 3.24964795041962, 0.00203267336923649, 0.999422260223299, 3.26970750566912, 0.00190403046968643, 0.999461706287869, 3.28976706091862, 0.00178281163674865, 0.999498648232106, 3.30982661616813, 0.00166863863863769, 0.999533231104923, 3.32988617141763, 0.00156114916443331, 0.999565592530032, 3.34994572666714, 0.00145999636866889, 0.999595863020756, 3.37000528191664, 0.00136484841506157, 0.999624166285675, 3.39006483716614, 0.00127538802051103, 0.999650619525134, 3.41012439241565, 0.00119131200044589, 0.999675333718599, 3.43018394766515, 0.00111233081644751, 0.999698413902919, 3.45024350291465, 0.00103816812707856, 0.999719959441536, 3.47030305816416, 0.000968560342757257, 0.999740064284726, 3.49036261341366, 0.000903256185432872, 0.999758817220952, 3.51042216866317, 0.000842016253776661, 0.999776302119438, 3.53048172391267, 0.000784612594551991, 0.999792598164079, 3.55054127916217, 0.000730828280684358, 0.999807780078818, 3.57060083441168, 0.000680456996645288, 0.999821918344628, 3.59066038966118, 0.000633302631554322, 0.999835079408256, 3.61071994491069, 0.000589178880425255, 0.999847325882882, 3.63077950016019, 0.000547908853974351, 0.999858716740863, 3.65083905540969, 0.000509324697223218, 0.999869307498738, 3.6708986106592, 0.000473267217247605, 0.999879150394671, 3.6909581659087, 0.000439585520263079, 0.999888294558522, 3.7110177211582, 0.000408136658227607, 0.999896786174732, 3.73107727640771, 0.000378785285121379, 0.999904668638213, 3.75113683165721, 0.000351403323022935, 0.999911982703442, 3.77119638690672, 0.000325869638045291, 0.999918766626959, 3.79125594215622, 0.000302069726176216, 0.999925056303459, 3.81131549740572, 0.000279895409047721, 0.999930885395682, 3.83137505265523, 0.000259244539595893, 0.999936285458302, 3.85143460790473, 0.000240020717619431, 0.999941286056012, 3.87149416315423, 0.0002221330151179, 0.999945914875994, 3.89155371840374, 0.000205495711351528, 0.999950197834991, 3.91161327365324, 0.000190028037542386, 0.999954159181145, 3.93167282890275, 0.000175653931025924, 0.999957821590827, 3.95173238415225, 0.00016230179878095, 0.999961206260614, 3.97179193940175, 0.000149904290158185, 0.999964332994626, 3.99185149465126, 0.00013839807862471, 0.999967220287395, 4.01191104990076, 0.000127723652347258, 0.999969885402436, 4.03197060515027, 0.000117825113453787, 0.999972344446717, 4.05203016039977, 0.000108649985754751, 0.999974612441182, 4.07208971564927, 0.000100149030705435, 0.999976703387501, 4.09214927089878, 9.22760714045944e-05, 0.999978630331211, 4.11220882614828, 8.49878244218233e-05, 0.999980405421406, 4.13226838139778, 7.82437392461059e-05, 0.99998203996713, 4.15232793664729, 7.20058450677779e-05, 0.999983544490627, 4.17238749189679, 6.62386047278208e-05, 0.999984928777585, 4.1924470471463, 6.0908775596535e-05, 0.999986201924529, 4.2125066023958, 5.59852771297403e-05, 0.999987372383483, 4.2325661576453, 5.14390648811213e-05, 0.999988448004049, 4.25262571289481, 4.72430107438172e-05, 0.999989436073011, 4.27268526814431, 4.33717892136813e-05, 0.999990343351617, 4.29274482339381, 3.98017694224078e-05, 0.999991176110615, 4.31280437864332, 3.65109127301932e-05, 0.999991940163202, 4.33286393389282, 3.34786756593152e-05, 0.999992640895958, 4.35292348914233, 3.06859179472575e-05, 0.999993283297891, 4.37298304439183, 2.81148155339532e-05, 0.999993871987691, 4.39304259964133, 2.57487782368703e-05, 0.999994411239282, 4.41310215489084, 2.35723719257516e-05, 0.99999490500577, 4.43316171014034, 2.15712450392716e-05, 0.999995356941876, 4.45322126538985, 1.97320591724237e-05, 0.999995770424933, 4.47328082063935, 1.80424236239327e-05, 0.999996148574538, 4.49334037588885, 1.64908336767824e-05, 0.99999649427092, 4.51339993113836, 1.50666124347439e-05, 0.999996810172116, 4.53345948638786, 1.37598560876074e-05, 0.999997098730009, 4.55351904163736, 1.25613823754374e-05, 0.999997362205303, 4.57357859688687, 1.14626821466839e-05, 0.999997602681497, 4.59363815213637, 1.04558738109112e-05, 0.999997822077915, 4.61369770738588, 9.53366058098046e-06, 0.999998022161854, 4.63375726263538, 8.6892903303459e-06, 0.999998204559897, 4.65381681788488, 7.91651793540426e-06, 0.999998370768453, 4.67387637313439, 7.20956997559632e-06, 0.999998522163555, 4.69393592838389, 6.56311164459655e-06, 0.999998660009987, 4.71399548363339, 5.97221580340548e-06, 0.999998785469756, 4.7340550388829, 5.43233397609783e-06, 0.999998899609973, 4.7541145941324, 4.93926924948635e-06, 0.999999003410163, 4.77417414938191, 4.48915095770442e-06, 0.999999097769062, 4.79423370463141, 4.07841098843633e-06, 0.999999183510907, 4.81429325988091, 3.70376169419221e-06, 0.999999261391283, 4.83435281513042, 3.36217529516653e-06, 0.999999332102531, 4.85441237037992, 3.05086464084879e-06, 0.999999396278765, 4.87447192562943, 2.7672652888781e-06, 0.999999454500507, 4.89453148087893, 2.50901883195708e-06, 0.999999507298987, 4.91459103612843, 2.27395735659897e-06, 0.999999555160111, 4.93465059137794, 2.06008898666292e-06, 0.999999598528133, 4.95471014662744, 1.86558445633084e-06, 0.999999637809048, 4.97476970187694, 1.68876460460152e-06, 0.999999673373722, 4.99482925712645, 1.52808879406811e-06, 0.999999705560782, 5.01488881237595, 1.38214412945075e-06, 0.999999734679285, 5.03494836762546, 1.24963547311625e-06, 0.999999761011175, 5.05500792287496, 1.12937618840208e-06, 0.999999784813549, 5.07506747812446, 1.0202795387948e-06, 0.999999806320743, 5.09512703337397, 9.21350759566352e-07, 0.999999825746257, 5.11518658862347, 8.31679674571999e-07, 0.999999843284516, 5.13524614387297, 7.50433905254031e-07, 0.999999859112505, 5.15530569912248, 6.76852561158569e-07, 0.999999873391257, 5.17536525437198, 6.1024042303502e-07, 0.999999886267228, 5.19542480962149, 5.49962579775366e-07, 0.99999989787356, 5.21548436487099, 4.95439444476046e-07, 0.999999908331238, 5.23554392012049, 4.46142182830025e-07, 0.99999991775015, 5.25560347537, 4.01588492968083e-07, 0.999999926230065, 5.2756630306195, 3.61338722912908e-07, 0.999999933861523, 5.295722585869, 3.24992264764814e-07, 0.999999940726653, 5.31578214111851, 2.9218425329242e-07, 0.999999946899924, 5.33584169636801, 2.62582549556953e-07, 0.999999952448826, 5.35590125161752, 2.35884923783362e-07, 0.999999957434502, 5.37596080686702, 2.11816495591983e-07, 0.999999961912319, 5.39602036211652, 1.90127370709672e-07, 0.999999965932391, 5.41607991736603, 1.70590471393183e-07, 0.99999996954006, 5.43613947261553, 1.52999555030089e-07, 0.999999972776329, 5.45619902786504, 1.37167379407489e-07, 0.999999975678266, 5.47625858311454, 1.22924028485158e-07, 0.999999978279362, 5.49631813836404, 1.10115384836462e-07, 0.999999980609869, 5.51637769361355, 9.86017183166266e-08, 0.999999982697094, 5.53643724886305, 8.82564020275799e-08, 0.999999984565682, 5.55649680411255, 7.89647445101043e-08, 0.999999986237862, 5.57655635936206, 7.06228966535716e-08, 0.999999987733677, 5.59661591461156, 6.31368748329891e-08, 0.99999998907119, 5.61667546986107, 5.64216670655553e-08, 0.999999990266672, 5.63673502511057, 5.04004028155219e-08, 0.999999991334777, 5.65679458036007, 4.50036113531981e-08, 0.999999992288692, 5.67685413560958, 4.01685354602911e-08, 0.999999993140282, 5.69691369085908, 3.58385060162368e-08, 0.999999993900218, 5.71697324610858, 3.19623802328139e-08, 0.999999994578091, 5.73703280135809, 2.84940075619386e-08, 0.99999999518252, 5.75709235660759, 2.53917841576034e-08, 0.999999995721245, 5.7771519118571, 2.26182101051294e-08, 0.999999996201216, 5.7972114671066, 2.01394909275009e-08, 0.999999996628668, 5.8172710223561, 1.79251999726703e-08, 0.999999997009194, 5.83733057760561, 1.59479463355028e-08, 0.999999997347811, 5.85739013285511, 1.41830898241098e-08, 0.999999997649012, 5.87744968810462, 1.26084642281322e-08, 0.999999997916824, 5.89750924335412, 1.12041476314189e-08, 0.999999998154852, 5.91756879860362, 9.95223549201934e-09, 0.999999998366324, 5.93762835385313, 8.83665246461834e-09, 0.999999998554127, 5.95768790910263, 7.84296422297036e-09, 0.999999998720843, 5.97774746435213, 6.95821418818636e-09, 0.99999999886878, 5.99780701960164, 6.54154477978585e-09, 0.999999999
};

inline double
fastncdf_pos(double const x) noexcept {
    int const i = static_cast<int>(x * hinv),
            inc = i * 3L;

    // bounds checks
    if(i >= n_pts - 1)
        return pnorm_xmax + (x - xmax) * (1 - pnorm_xmax) / (xinf - xmax);

    double const x0 = d_xmy[inc     ],
                 m0 = d_xmy[inc + 1L],
                 y0 = d_xmy[inc + 2L],
                 m1 = d_xmy[inc + 4L],
                 y1 = d_xmy[inc + 5L],
                  t = (x - x0) / h,
                 t1 = t - 1,
                h01 = t * t * (3 - 2 * t),
                h00 = 1 - h01,
                tt1 = t * t1,
                h10 = tt1 * t1,
                h11 = tt1 * t;

    return y0 * h00 + h * m0 * h10 + y1 * h01 + h * m1 * h11;
}
} // namespace

double pnorm_approx(double const x) noexcept {
  return x < 0. ? 1.0 - fastncdf_pos(-x) : fastncdf_pos(x);
}
