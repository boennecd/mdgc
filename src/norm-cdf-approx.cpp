#include "norm-cdf-approx.h"
namespace {
constexpr double const h = 0.0254867171592268,
                    hinv = 1. / h,
                    xmax = 5.3267238862784,
              pnorm_xmax = 0.99999995,
                    xinf = 8.12589066470191; // qnorm(1 - .Machine$double.eps)
constexpr int const n_pts = 210L;
constexpr double const d_xmy[3L * n_pts] = {
  0, 0.398899094270266, 0.5, 0.0254867171592268, 0.398769586356725, 0.510166628390738, 0.0509734343184536, 0.398381314840331, 0.520326655318351, 0.0764601514776804, 0.397735035575246, 0.530473492176451, 0.101946868636907, 0.396832005593708, 0.540600576030394, 0.127433585796134, 0.395673979031969, 0.550701382349042, 0.152920302955361, 0.39426320145253, 0.560769437612101, 0.178407020114588, 0.392602402588354, 0.570798331752466, 0.203893737273814, 0.390694787541928, 0.580781730393706, 0.229380454433041, 0.388544026478844, 0.590713386843796, 0.254867171592268, 0.386154242862305, 0.600587153807253, 0.280353888751495, 0.383530000281351, 0.61039699477913, 0.305840605910721, 0.380676287931667, 0.620136995085751, 0.331327323069948, 0.377598504813647, 0.629801372538608, 0.356814040229175, 0.374302442717745, 0.639384487669615, 0.382300757388402, 0.370794268072125, 0.648880853517717, 0.407787474547629, 0.367080502732198, 0.658285144938849, 0.433274191706855, 0.363168003795784, 0.667592207413322, 0.458760908866082, 0.359063942531236, 0.676797065326897, 0.484247626025309, 0.354775782509048, 0.685894929704063, 0.509734343184536, 0.350311257030123, 0.6948812053744, 0.535221060343763, 0.34567834594608, 0.703751497555303, 0.560707777502989, 0.340885251968513, 0.712501617836794, 0.586194494662216, 0.335940376565343, 0.721127589556649, 0.611681211821443, 0.330852295542971, 0.729625652556564, 0.63716792898067, 0.325629734412947, 0.737992267312619, 0.662654646139897, 0.320281543641553, 0.746224118435798, 0.688141363299123, 0.314816673879695, 0.754318117540844, 0.71362808045835, 0.309244151269098, 0.762271405484159, 0.739114797617577, 0.303573052918932, 0.770081353973926, 0.764601514776804, 0.297812482644633, 0.777745566557974, 0.790088231936031, 0.291971547057869, 0.785261878997227, 0.815574949095257, 0.286059332093533, 0.792628359034786, 0.841061666254484, 0.280084880055933, 0.799843305572878, 0.866548383413711, 0.274057167262546, 0.806905247271909, 0.892035100572938, 0.267985082359406, 0.813812940587837, 0.917521817732164, 0.261877405377592, 0.820565367265882, 0.943008534891391, 0.255742787595638, 0.827161731310338, 0.968495252050618, 0.249589732267493, 0.833601455451806, 0.993981969209845, 0.243426576270504, 0.839884177134636, 1.01946868636907, 0.237261472722513, 0.846009744048697, 1.0449554035283, 0.231102374611611, 0.851978209230756, 1.07044212068753, 0.224957019476513, 0.8577898257618, 1.09592883784675, 0.21883291516986, 0.863445041087518, 1.12141555500598, 0.212737326731024, 0.868944490989927, 1.14690227216521, 0.20667726438939, 0.874288993238725, 1.17238898932443, 0.200659472713423, 0.879479540951397, 1.19787570648366, 0.194690420915231, 0.884517295691458, 1.22336242364289, 0.188776294314985, 0.889403580334352, 1.24884914080211, 0.182922986964174, 0.894139871730604, 1.27433585796134, 0.17713609542149, 0.898727793195705, 1.29982257512057, 0.171420913670265, 0.903169106855999, 1.32530929227979, 0.165782429161512, 0.907465705879486, 1.35079600943902, 0.160225319962144, 0.911619606620017, 1.37628272659825, 0.154753952983679, 0.915632940702729, 1.40176944375747, 0.149372383262657, 0.919507947077951, 1.4272561609167, 0.144084354260258, 0.923246964069959, 1.45274287807593, 0.138893299145261, 0.926852421446153, 1.47822959523515, 0.133802343021161, 0.930326832531214, 1.50371631239438, 0.128814306055559, 0.933672786389798, 1.52920302955361, 0.123931707467382, 0.936892940100214, 1.55468974671283, 0.1191567703252, 0.93999001114036, 1.58017646387206, 0.114491427108136, 0.942966769905985, 1.60566318103129, 0.109937325979209, 0.945826032380083, 1.63114989819051, 0.105495837719715, 0.948570652970932, 1.65663661534974, 0.101168063272307, 0.951203517534959, 1.68212333250897, 0.0969548418397834, 0.953727536599268, 1.70761004966819, 0.0928567594862423, 0.956145638797335, 1.73309676682742, 0.0888741581872185, 0.958460764529965, 1.75858348398665, 0.0850071452755883, 0.960675859862299, 1.78407020114588, 0.0812556032305338, 0.962793870666269, 1.8095569183051, 0.0776191997575532, 0.964817737016577, 1.83504363546433, 0.0740973981084703, 0.966750387846962, 1.86053035262356, 0.0706894675915826, 0.968594735872227, 1.88601706978278, 0.0673944942234149, 0.970353672780248, 1.91150378694201, 0.0642113914751281, 0.97203006469695, 1.93699050410124, 0.0611389110683592, 0.973626747926102, 1.96247722126046, 0.0581756537771701, 0.975146524964595, 1.98796393841969, 0.0553200801946978, 0.976592160792845, 2.01345065557892, 0.0525705214253266, 0.977966379438891, 2.03893737273814, 0.0499251896653608, 0.979271860813806, 2.06442408989737, 0.0473821886374819, 0.980511237815134, 2.0899108070566, 0.0449395238466588, 0.981687093694183, 2.11539752421582, 0.0425951126275475, 0.982801959682235, 2.14088424137505, 0.0403467939559134, 0.983858312869991, 2.16637095853428, 0.038192337998984, 0.984858574333907, 2.1918576756935, 0.0361294553821733, 0.98580510750245, 2.21734439285273, 0.0341558061520107, 0.986700216754791, 2.24283111001196, 0.0322690084175148, 0.987546146243934, 2.26831782717118, 0.0304666466546695, 0.988345078935883, 2.29380454433041, 0.0287462796609404, 0.989099135856089, 2.31929126148964, 0.0271054481490452, 0.98981037553408, 2.34477797864886, 0.0255416819713952, 0.990480793636986, 2.37026469580809, 0.0240525069687195, 0.991112322782432, 2.39575141296732, 0.0226354514384172, 0.991706832521151, 2.42123813012654, 0.0212880522201174, 0.992266129479596, 2.44672484728577, 0.0200078603977736, 0.992791957652761, 2.472211564445, 0.0187924466193002, 0.993285998837435, 2.49769828160423, 0.017639406036455, 0.993749873196193, 2.52318499876345, 0.0165463628691308, 0.994185139942451, 2.54867171592268, 0.0155109745996288, 0.994593298137112, 2.57415843308191, 0.0145309358038095, 0.99497578758742, 2.59964515024113, 0.013603981627125, 0.995333989838893, 2.62513186740036, 0.012727890914687, 0.99566922925136, 2.65061858455959, 0.0119004890053953, 0.995982774150445, 2.67610530171881, 0.0111196502010069, 0.996275838046034, 2.70159201887804, 0.0103832999218168, 0.99654958090961, 2.72707873603727, 0.00968941656115853, 0.996805110502608, 2.75256545319649, 0.00903603305150262, 0.997043483748274, 2.77805217035572, 0.00842123815539012, 0.997265708139858, 2.80353888751495, 0.00784317749467085, 0.997472743178268, 2.82902560467417, 0.00730005433185248, 0.99766550183273, 2.8545123218334, 0.00679013011746679, 0.997844852018274, 2.87999903899263, 0.00631172481747486, 0.998011618084287, 2.90548575615185, 0.00586321703468188, 0.998166582308694, 2.93097247331108, 0.00544304393809474, 0.998310486392699, 2.95645919047031, 0.0050497010140395, 0.998444032951365, 2.98194590762953, 0.00468174165259228, 0.998567886995666, 3.00743262478876, 0.00433777658271474, 0.998682677401989, 3.03291934194799, 0.00401647316911893, 0.998788998365393, 3.05840605910721, 0.00371655458357681, 0.998887410833267, 3.08389277626644, 0.00343679886301469, 0.99897844391635, 3.10937949342567, 0.00317603786627442, 0.999062596274377, 3.1348662105849, 0.00293315614104787, 0.999140337473919, 3.16035292774412, 0.00270708971198161, 0.999212109316278, 3.18583964490335, 0.00249682480044304, 0.999278327133547, 3.21132636206258, 0.00230139648599994, 0.999339381051248, 3.2368130792218, 0.00211988731909257, 0.999395637216167, 3.26229979638103, 0.00195142589386701, 0.99944743898827, 3.28778651354026, 0.0017951853896599, 0.999495108095795, 3.31327323069948, 0.00165038208903432, 0.99953894575282, 3.33875994785871, 0.00151627387973975, 0.999579233738811, 3.36424666501794, 0.00139215874754377, 0.999616235439837, 3.38973338217716, 0.0012773732662714, 0.99965019685129, 3.41522009933639, 0.00117129109086545, 0.999681347542126, 3.44070681649562, 0.00107332145893039, 0.999709901580778, 3.46619353365484, 0.000982907705618915, 0.999736058423015, 3.49168025081407, 0.000899525796245536, 0.999760003762151, 3.5171669679733, 0.000822682880678379, 0.999781910342108, 3.54265368513252, 0.000751915873055203, 0.999801938733935, 3.56814040229175, 0.000686790059942431, 0.999820238076476, 3.59362711945098, 0.000626897739685885, 0.999836946781946, 3.6191138366102, 0.000571856895388319, 0.999852193207234, 3.64460055376943, 0.000521309903504532, 0.999866096291842, 3.67008727092866, 0.000474922279739807, 0.99987876616336, 3.69557398808788, 0.000432381463700032, 0.999890304711475, 3.72106070524711, 0.000393395643319429, 0.999900806131501, 3.74654742240634, 0.000357692619956717, 0.999910357438461, 3.77203413956556, 0.000325018714712898, 0.99991903895277, 3.79752085672479, 0.000295137716297361, 0.999926924758568, 3.82300757388402, 0.000267829870627454, 0.999934083135767, 3.84849429104325, 0.000242890912061361, 0.999940576966887, 3.87398100820247, 0.000220131136055172, 0.999946464119719, 3.8994677253617, 0.000199374512845528, 0.999951797806892, 3.92495444252093, 0.00018045784162862, 0.999956626923355, 3.95044115968015, 0.000163229944586494, 0.999960996362829, 3.97592787683938, 0.000147550899980887, 0.999964947314214, 4.00141459399861, 0.000133291313452108, 0.999968517538938, 4.02690131115783, 0.000120331626582032, 0.999971741630225, 4.05238802831706, 0.000108561461712817, 0.999974651255202, 4.07787474547629, 9.78790019192146e-05, 0.999977275380763, 4.10336146263551, 8.81904050367311e-05, 0.999979640484078, 4.12884817979474, 7.94092505695487e-05, 0.999981770748582, 4.15433489695397, 7.14560182911182e-05, 0.999983688246296, 4.17982161411319, 6.42575973504302e-05, 0.999985413107237, 4.20530833127242, 5.77468246185003e-05, 0.999986963676714, 4.23079504843165, 5.18620510923841e-05, 0.999988356661209, 4.25628176559087, 4.65467351305191e-05, 0.999989607263569, 4.2817684827501, 4.17490612713403e-05, 0.999990729308155, 4.30725519990933, 3.74215834721041e-05, 0.999991735356601, 4.33274191706855, 3.35208915678324e-05, 0.999992636814782, 4.35822863422778, 3.00072997807497e-05, 0.999993444031566, 4.38371535138701, 2.68445561607146e-05, 0.999994166389906, 4.40920206854623, 2.39995718393002e-05, 0.999994812390786, 4.43468878570546, 2.14421690063231e-05, 0.999995389730505, 4.46017550286469, 1.91448465982215e-05, 0.99999590537178, 4.48566222002392, 1.70825626440973e-05, 0.999996365609086, 4.51114893718314, 1.5232532315442e-05, 0.999996776128665, 4.53663565434237, 1.35740407713097e-05, 0.999997142063571, 4.5621223715016, 1.20882698296992e-05, 0.99999746804414, 4.58760908866082, 1.07581376549208e-05, 0.9999977582442, 4.61309580582005, 9.56815062239677e-06, 0.999998016423363, 4.63858252297928, 8.50426656808824e-06, 0.999998245965697, 4.6640692401385, 7.55376867984033e-06, 0.999998449915037, 4.68955595729773, 6.70514930317473e-06, 0.999998631007229, 4.71504267445696, 5.94800300593996e-06, 0.999998791699524, 4.74052939161618, 5.27292823969668e-06, 0.999998934197369, 4.76601610877541, 4.67143701411977e-06, 0.999999060478786, 4.79150282593464, 4.13587199634801e-06, 0.999999172316557, 4.81698954309386, 3.65933050383765e-06, 0.999999271298385, 4.84247626025309, 3.23559486798937e-06, 0.9999993588452, 4.86796297741232, 2.85906871987385e-06, 0.999999436227768, 4.89344969457154, 2.52471875373338e-06, 0.999999504581752, 4.91893641173077, 2.22802147820033e-06, 0.999999564921353, 4.94442312889, 1.96491466990986e-06, 0.999999618151658, 4.96990984604922, 1.73175309171915e-06, 0.999999665079802, 4.99539656320845, 1.52526815536193e-06, 0.999999706425061, 5.02088328036768, 1.34253121054339e-06, 0.999999742827958, 5.0463699975269, 1.18092014901545e-06, 0.999999774858487, 5.07185671468613, 1.03808909711666e-06, 0.999999803023514, 5.09734343184536, 9.11940874425723e-07, 0.999999827773453, 5.12283014900459, 8.00602031217149e-07, 0.999999849508272, 5.14831686616381, 7.02400238202952e-07, 0.999999868582888, 5.17380358332304, 6.15843791153363e-07, 0.999999885312025, 5.19929030048227, 5.39603104070414e-07, 0.999999899974562, 5.22477701764149, 4.72493966575823e-07, 0.999999912817448, 5.25026373480072, 4.134624239404e-07, 0.999999924059202, 5.27575045195995, 3.61571162140937e-07, 0.999999933893048, 5.30123716911917, 3.15987191030282e-07, 0.999999942489726, 5.3267238862784, 2.94674059254395e-07, 0.99999995
};

inline double
fastncdf_pos(double const x) noexcept {
    int const i = static_cast<int>(x * hinv),
            inc = i * 3L;

    // bounds checks
    if(i >= n_pts - 1)
        return pnorm_xmax + (x - xmax) * (1 - pnorm_xmax) / (xinf - xmax);

    double const x0 = d_xmy[inc     ],
                 m0 = d_xmy[inc + 1L],
                 y0 = d_xmy[inc + 2L],
                 m1 = d_xmy[inc + 4L],
                 y1 = d_xmy[inc + 5L],
                  t = (x - x0) / h,
                 t1 = t - 1,
                h01 = t * t * (3 - 2 * t),
                h00 = 1 - h01,
                tt1 = t * t1,
                h10 = tt1 * t1,
                h11 = tt1 * t;

    return y0 * h00 + h * m0 * h10 + y1 * h01 + h * m1 * h11;
}
} // namespace

double pnorm_approx(double const x) noexcept {
  return x < 0. ? .5 - fastncdf_pos(-x) + .5 : fastncdf_pos(x);
}

// #include "Rcpp.h"
//
// // [[Rcpp::export(rng = false)]]
// Rcpp::NumericVector test_func(Rcpp::NumericVector x){
//   Rcpp::NumericVector out = Rcpp::clone(x);
//   for(auto &o : out)
//     o = pnorm_approx(o);
//
//   return out;
// }

/*** R
test_vals <- exp(seq(log(.Machine$double.eps), log(1 - .Machine$double.eps),
                     length.out = 10000))
test_vals <- qnorm(test_vals)

truth <- pnorm(test_vals)
res <- test_func(test_vals)
max(abs(truth - res) / truth)
range(truth - res)
all(res >= 0)
min(res)

plot(test_vals, (truth - res) / truth, type = "h")
plot(test_vals,  truth - res, type = "h")
plot(test_vals[test_vals > 4],  (truth - res)[test_vals > 4], type = "h")

bench::mark(pnorm(test_vals), test_func(test_vals), min_time = 2,
            check = FALSE)
*/
